var Exitgames,Photon,__extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])};return function(e,t){function o(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}}();!function(e){!function(e){var t=function(){function r(e,t){void 0===e&&(e=""),void 0===t&&(t=r.Level.INFO),this.prefix=e,this.level=t}return r.prototype.setLevel=function(e){e=Math.max(e,r.Level.DEBUG),e=Math.min(e,r.Level.OFF),this.level=e},r.prototype.isLevelEnabled=function(e){return e>=this.level},r.prototype.getLevel=function(){return this.level},r.prototype.debug=function(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];this.log(r.Level.DEBUG,e,t)},r.prototype.info=function(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];this.log(r.Level.INFO,e,t)},r.prototype.warn=function(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];this.log(r.Level.WARN,e,t)},r.prototype.error=function(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];this.log(r.Level.ERROR,e,t)},r.prototype.format=function(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];return this.format0(e,t)},r.prototype.formatArr=function(e,t){return this.format0(e,t)},r.prototype.log=function(e,t,o){if(e>=this.level&&"undefined"!=typeof console&&void 0!==t)try{var n=console[r.log_types[e]];n||(n=console.log),n&&n.apply(console,[this.prefix,t].concat(o))}catch(e){}},r.prototype.format0=function(e,t){return(""==this.prefix?"":this.prefix+" ")+e+" "+t.map(function(t){if(void 0!==t)switch(typeof t){case"object":try{return JSON.stringify(t)}catch(e){return t.toString()+"("+e+")"}default:return t.toString()}}).join(" ")},r.Level={DEBUG:1,INFO:2,WARN:3,ERROR:4,OFF:6},r.log_types=["debug","debug","info","warn","error"],r}();e.Logger=t;var o=function(){function e(){}return e.indexOf=function(e,t,o){for(var n=e.length,r=o<0?Math.max(0,n+o):o||0;r<n;r++)if(e[r]===t)return r;return-1},e.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)},e.merge=function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])},e.getPropertyOrElse=function(e,t,o){return e.hasOwnProperty(t)?e[t]:o},e.enumValueToName=function(e,t){for(var o in e)if(t==e[o])return o;return"undefined"},e.getEnumKeyByValue=function(e,t){for(var o in e)if(t==e[o])return o},e}();e.Util=o}(e.Common||(e.Common={}))}(Exitgames||(Exitgames={})),function(e){e.ConnectionProtocol={Ws:0,Wss:1};var t=function(){function e(){}return e.Byte=function(e){return e},e.Short=function(e){return e},e.Int=function(e){return e},e.Long=function(e){return e},e.Float=function(e){return e},e.Double=function(e){return e},e.String=function(e){return e},e}();e.TypeExt=t;var o=function(){function o(e,t,o){void 0===t&&(t=""),void 0===o&&(o=""),this.url=e,this.subprotocol=t,this.keepAliveTimeoutMs=3e3,this._frame="~m~",this._isConnecting=!1,this._isConnected=!1,this._isClosing=!1,this._peerStatusListeners={},this._eventListeners={},this._responseListeners={},this.lastRtt=0,this.initTimestamp=Date.now(),this.keepAliveTimer=0,this._logger=new Exitgames.Common.Logger(o&&""!=o?o+":":"")}return o.prototype.isConnecting=function(){return this._isConnecting},o.prototype.getLastRtt=function(){return this.lastRtt},o.prototype.isConnected=function(){return this._isConnected},o.prototype.isClosing=function(){return this._isClosing},o.prototype.connect=function(e){var o=this;this._sessionid=void 0,""==this.subprotocol?this._socket=new WebSocket(this.url,"Json"):this._socket=new WebSocket(this.url,this.subprotocol),this._onConnecting(),this._socket.onopen=function(e){},this._socket.onmessage=function(e){var t=o._decode(e.data);o._onMessage(t.toString())},this._socket.onclose=function(e){o._logger.debug("onclose: wasClean =",e.wasClean,", code=",e.code,", reason =",e.reason),o._isConnecting?o._onConnectFailed(e):(1006==e.code&&o._onTimeout(),o._onDisconnect())},this._socket.onerror=function(e){o._onError(e)}},o.prototype.disconnect=function(){this._isClosing=!0,this._socket.close()},o.prototype.sendOperation=function(e,t,o,n){void 0===o&&(o=!1),void 0===n&&(n=0);var r={req:e,vals:[]};if(Exitgames.Common.Util.isArray(t))r.vals=t;else{if(void 0!==t)throw new Error(this._logger.format("PhotonPeer[sendOperation] - Trying to send non array data:",t));r.vals=[]}this._send(r),this._logger.debug("PhotonPeer[sendOperation] - Sending request:",r)},o.prototype.addPeerStatusListener=function(e,t){this._addListener(this._peerStatusListeners,e,t)},o.prototype.addEventListener=function(e,t){this._addListener(this._eventListeners,e.toString(),t)},o.prototype.addResponseListener=function(e,t){this._addListener(this._responseListeners,e.toString(),t)},o.prototype.removePeerStatusListener=function(e,t){this._removeListener(this._peerStatusListeners,e,t)},o.prototype.removeEventListener=function(e,t){this._removeListener(this._eventListeners,e.toString(),t)},o.prototype.removeResponseListener=function(e,t){this._removeListener(this._responseListeners,e.toString(),t)},o.prototype.removePeerStatusListenersForCode=function(e){this._removeListenersForCode(this._peerStatusListeners,e)},o.prototype.removeEventListenersForCode=function(e){this._removeListenersForCode(this._eventListeners,e.toString())},o.prototype.removeResponseListenersForCode=function(e){this._removeListenersForCode(this._responseListeners,e.toString())},o.prototype.setLogLevel=function(e){this._logger.setLevel(e)},o.prototype.onUnhandledEvent=function(e,t){this._logger.warn("PhotonPeer: No handler for event",e,"registered.")},o.prototype.onUnhandledResponse=function(e,t){this._logger.warn("PhotonPeer: No handler for response",e,"registered.")},o.prototype._dispatchEvent=function(e,t){this._dispatch(this._eventListeners,e.toString(),t,"event")||this.onUnhandledEvent(e,t)},o.prototype._dispatchResponse=function(e,t){this._dispatch(this._responseListeners,e.toString(),t,"response")||this.onUnhandledResponse(e,t)},o.prototype._stringify=function(e){if("[object Object]"==Object.prototype.toString.call(e)){if(!JSON)throw new Error("PhotonPeer[_stringify] - Trying to encode as JSON, but JSON.stringify is missing.");return"~j~"+JSON.stringify(e)}return String(e)},o.prototype._encode=function(e){for(var t,o="",n=0,r=(e=Exitgames.Common.Util.isArray(e)?e:[e]).length;n<r;n++)t=null===e[n]||void 0===e[n]?"":this._stringify(e[n]),o+=this._frame+t.length+this._frame+t;return o},o.prototype._decode=function(e){var t,o,n=[],r=e;-1!==e.indexOf("\0")&&(r=e.replace(/[\0]/g,"")),e=r;do{if(e.substr(0,3)!==this._frame)return n;o=t="";for(var s=0,a=(e=e.substr(3)).length;s<a;s++){if(o=Number(e.substr(s,1)),e.substr(s,1)!=o){e=e.substr(t.length+this._frame.length),t=Number(t);break}t+=o}n.push(e.substr(0,t)),e=e.substr(t)}while(""!==e);return n},o.prototype._onMessage=function(e){"~j~"==e.substr(0,3)?this._onMessageReceived(JSON.parse(e.substr(3))):this._sessionid?this._onMessageReceived(e):(this._sessionid=e,this._onConnect())},o.prototype.resetKeepAlive=function(){var e=this;clearTimeout(this.keepAliveTimer),1e3<=this.keepAliveTimeoutMs&&(this.keepAliveTimer=setTimeout(function(){e._send({irq:1,vals:[1,Date.now()-e.initTimestamp]},!0)},this.keepAliveTimeoutMs))},o.prototype._send=function(e,t){void 0===t&&(t=!1);var o=this._encode(e);if(this._isConnected&&!this._isClosing)this.resetKeepAlive(),this._socket.send(o);else if(!t)throw new Error(this._logger.format("PhotonPeer[_send] - Operation",e.req,'- failed, "isConnected" is',this._isConnected,', "isClosing" is',this._isClosing,"!"))},o.prototype._onMessageReceived=function(e){if("object"==typeof e){this._logger.debug("PhotonPeer[_onMessageReceived] - Socket received message:",e);var t=e;t.err&&t.err;if(t.vals=void 0!==t.vals?t.vals:[],0<t.vals.length&&(t.vals=this._parseMessageValuesArrayToJSON(t.vals)),void 0!==t.res){var o=parseInt(t.res);this._parseResponse(o,t)}else if(void 0!==t.evt){o=parseInt(t.evt);this._parseEvent(o,t)}else{if(void 0===t.irs)throw new Error(this._logger.format("PhotonPeer[_onMessageReceived] - Received undefined message type:",t));o=parseInt(t.irs);this._parseInternalResponse(o,t)}}},o.prototype._parseMessageValuesArrayToJSON=function(e){var t={};if(Exitgames.Common.Util.isArray(e)){if(e.length%2!=0)throw new Error(this._logger.format("PhotonPeer[_parseMessageValuesToJSON] - Received invalid values array:",e));for(var o,n,r=e;0<r.length;)o=r.shift()+"",n=r.shift(),t[o]=n}return t},o.prototype._parseEvent=function(e,t){this._dispatchEvent(e,{vals:t.vals})},o.prototype._parseResponse=function(e,t){this._dispatchResponse(e,{errCode:t.err,errMsg:t.msg,vals:t.vals})},o.prototype._parseInternalResponse=function(e,t){this.lastRtt=Date.now()-this.initTimestamp-t.vals[1],this._logger.debug("internal response:",t)},o.prototype._onConnecting=function(){this._logger.debug("PhotonPeer[_onConnecting] - Starts connecting",this.url,'..., raising "connecting" event ...'),this._isConnecting=!0,this._dispatchPeerStatus(o.StatusCodes.connecting),this.resetKeepAlive()},o.prototype._onConnect=function(){this._logger.debug('PhotonPeer[_onConnect] - Connected successfully! Raising "connect" event ...'),this._isConnecting=!1,this._isConnected=!0,this._dispatchPeerStatus(o.StatusCodes.connect),this.resetKeepAlive()},o.prototype._onConnectFailed=function(e){this._logger.error("PhotonPeer[_onConnectFailed] - Socket connection could not be created:",this.url,this.subprotocol,'Wrong host or port?\n Raising "connectFailed event ...'),this._isConnecting=this._isConnected=!1,this._dispatchPeerStatus(o.StatusCodes.connectFailed)},o.prototype._onDisconnect=function(){var e=this._isConnected,t=this._isClosing;this._logger.debug('PhotonPeer[_onDisconnect] - Socket closed, raising "disconnect" event ...'),this._isClosing=this._isConnected=this._isConnecting=!1,e&&(t?this._dispatchPeerStatus(o.StatusCodes.disconnect):this._dispatchPeerStatus(o.StatusCodes.connectClosed))},o.prototype._onTimeout=function(){this._logger.debug('PhotonPeer[_onTimeout] - Client timed out! Raising "timeout" event ...'),this._dispatchPeerStatus(o.StatusCodes.timeout)},o.prototype._onError=function(e){this._logger.error("PhotonPeer[_onError] - Connection error:",e),this._isConnecting=this._isConnected=this._isClosing=!1,this._dispatchPeerStatus(o.StatusCodes.error)},o.prototype._addListener=function(e,t,o){return t in e||(e[t]=[]),o&&"function"==typeof o?(this._logger.debug("PhotonPeer[_addListener] - Adding listener for event",t),e[t].push(o)):this._logger.error("PhotonPeer[_addListener] - Listener",t,"is not a function but of type",typeof o,". No listener added!"),this},o.prototype._dispatch=function(e,t,o,n){if(t in e){for(var r=e[t],s=0,a=r.length;s<a;s++)Exitgames.Common.Util.isArray(o)||(o=[o]),r[s].apply(this,void 0===o?[]:o);return!0}return!1},o.prototype._dispatchPeerStatus=function(e){this._dispatch(this._peerStatusListeners,e,void 0,"peerStatus")||this._logger.warn("PhotonPeer[_dispatchPeerStatus] - No handler for ",e,"registered.")},o.prototype._removeListener=function(e,t,o){if(t in e){var n=e[t].length;e[t]=e[t].filter(function(e){return e!=o}),this._logger.debug("PhotonPeer[_removeListener] - Removing listener for event",t,"removed:",n-e[t].length)}return this},o.prototype._removeListenersForCode=function(e,t){return this._logger.debug("PhotonPeer[_removeListenersForCode] - Removing all listeners for event",t),t in e&&(e[t]=[]),this},o.StatusCodes={connecting:"connecting",connect:"connect",connectFailed:"connectFailed",disconnect:"disconnect",connectClosed:"connectClosed",error:"error",timeout:"timeout"},o}();e.PhotonPeer=o}(Photon||(Photon={})),function(m){!function(h){var n={ws:"ws://",wss:"wss://"};function o(e,t){for(var o in n)if(0==e.indexOf(n[o]))return e;switch(t){case m.ConnectionProtocol.Ws:return n.ws+e;case m.ConnectionProtocol.Wss:return n.wss+e;default:return n.ws+e}}var r=function(){function e(e,t,o){this.name=e,this.actorNr=t,this.isLocal=o,this.customProperties={},this.suspended=!1}return e.prototype.getRoom=function(){return this.loadBalancingClient.myRoom()},e.prototype.raiseEvent=function(e,t,o){this.loadBalancingClient&&this.loadBalancingClient.raiseEvent(e,t,o)},e.prototype.setName=function(e){this.name=e},e.prototype.onPropertiesChange=function(e,t){},e.prototype.getCustomProperty=function(e){return this.customProperties[e]},e.prototype.getCustomPropertyOrElse=function(e,t){return Exitgames.Common.Util.getPropertyOrElse(this.customProperties,e,t)},e.prototype.setCustomProperty=function(e,t,o,n){void 0===o&&(o=!1),this.customProperties[e]=t;var r,s,a={};a[e]=t,null!=n&&((s={})[e]=n,r=s),this.loadBalancingClient&&this.loadBalancingClient.isJoinedToRoom()&&this.loadBalancingClient._setPropertiesOfActor(this.actorNr,a,o,r),this.onPropertiesChange(a,!0)},e.prototype.setCustomProperties=function(e,t,o){void 0===t&&(t=!1);var n={};for(var r in e)this.customProperties[r]=e[r],n[r]=e[r];this.loadBalancingClient&&this.loadBalancingClient.isJoinedToRoom()&&this.loadBalancingClient._setPropertiesOfActor(this.actorNr,n,t,o),this.onPropertiesChange(n,!0)},e.prototype.getJoinToken=function(){return this.joinToken},e.prototype.isSuspended=function(){return this.suspended},e.prototype._getAllProperties=function(){var e={};for(var t in e[h.Constants.ActorProperties.PlayerName]=this.name,this.customProperties)e[t]=this.customProperties[t];return e},e.prototype._setLBC=function(e){this.loadBalancingClient=e},e.prototype._updateFromResponse=function(e){this.actorNr=e[h.Constants.ParameterCode.ActorNr];var t=e[h.Constants.ParameterCode.PlayerProperties];if(void 0!==t){var o=t[h.Constants.ActorProperties.PlayerName];void 0!==o&&(this.name=o),this._updateCustomProperties(t)}},e.prototype._updateMyActorFromResponse=function(e){this.actorNr=e[h.Constants.ParameterCode.ActorNr],this.joinToken=this.actorNr?this.actorNr.toString():null},e.prototype._updateCustomProperties=function(e){for(var t in e)this.customProperties[t]=e[t];this.onPropertiesChange(e,!1)},e.prototype._setSuspended=function(e){this.suspended=e},e._getActorNrFromResponse=function(e){return e[h.Constants.ParameterCode.ActorNr]},e}();h.Actor=r;var l=function(){function e(e){this.name="",this.address="",this.maxPlayers=0,this.isVisible=!0,this.isOpen=!0,this.playerCount=0,this.emptyRoomLiveTime=0,this.suspendedPlayerLiveTime=0,this.uniqueUserId=!1,this.removed=!1,this.cleanupCacheOnLeave=!1,this.masterClientId=0,this._customProperties={},this._propsListedInLobby=[],this.name=e}return e.prototype.onPropertiesChange=function(e,t){},e.prototype.getCustomProperty=function(e){return this._customProperties[e]},e.prototype.getCustomPropertyOrElse=function(e,t){return Exitgames.Common.Util.getPropertyOrElse(this._customProperties,e,t)},e.prototype._updateFromMasterResponse=function(e){this.address=e[h.Constants.ParameterCode.Address];var t=e[h.Constants.ParameterCode.RoomName];t&&(this.name=t)},e.prototype._updateFromProps=function(e){if(e){this.maxPlayers=this.updateIfExists(this.maxPlayers,h.Constants.GameProperties.MaxPlayers,e),this.isVisible=this.updateIfExists(this.isVisible,h.Constants.GameProperties.IsVisible,e),this.isOpen=this.updateIfExists(this.isOpen,h.Constants.GameProperties.IsOpen,e),this.playerCount=this.updateIfExists(this.playerCount,h.Constants.GameProperties.PlayerCount,e),this.removed=this.updateIfExists(this.removed,h.Constants.GameProperties.Removed,e),this._propsListedInLobby=this.updateIfExists(this._propsListedInLobby,h.Constants.GameProperties.PropsListedInLobby,e),this.cleanupCacheOnLeave=this.updateIfExists(this.cleanupCacheOnLeave,h.Constants.GameProperties.CleanupCacheOnLeave,e),this.masterClientId=this.updateIfExists(this.masterClientId,h.Constants.GameProperties.MasterClientId,e);var t={};for(var o in e)parseInt(o).toString()!=o&&this._customProperties[o]!==e[o]&&(this._customProperties[o]=e[o],t[o]=e[o]);this.onPropertiesChange(t,!1)}},e.prototype._updateFromEvent=function(e){e&&(this.masterClientId=this.updateIfExists(this.masterClientId,h.Constants.ParameterCode.MasterClientId,e))},e.prototype.updateIfExists=function(e,t,o){return o.hasOwnProperty(t)?o[t]:e},e}(),t=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.prototype.setCustomProperty=function(e,t,o,n){void 0===o&&(o=!1),this._customProperties[e]=t;var r,s,a={};a[e]=t,null!=n&&((s={})[e]=n,r=s),this.loadBalancingClient&&this.loadBalancingClient.isJoinedToRoom()&&this.loadBalancingClient._setPropertiesOfRoom(a,o,r),this.onPropertiesChange(a,!0)},e.prototype.setCustomProperties=function(e,t,o){void 0===t&&(t=!1);var n={};for(var r in e)this._customProperties[r]=e[r],n[r]=e[r];this.loadBalancingClient&&this.loadBalancingClient.isJoinedToRoom()&&this.loadBalancingClient._setPropertiesOfRoom(n,t,o),this.onPropertiesChange(n,!0)},e.prototype.setProp=function(e,t){if(this.loadBalancingClient&&this.loadBalancingClient.isJoinedToRoom()){var o={};o[e]=t,this.loadBalancingClient._setPropertiesOfRoom(o,!1,void 0)}},e.prototype.setIsVisible=function(e){this.isVisible!=e&&(this.isVisible=e,this.setProp(h.Constants.GameProperties.IsVisible,e))},e.prototype.setIsOpen=function(e){this.isOpen!=e&&(this.isOpen=e,this.setProp(h.Constants.GameProperties.IsOpen,e))},e.prototype.setMaxPlayers=function(e){this.maxPlayers!=e&&(this.maxPlayers=e,this.setProp(h.Constants.GameProperties.MaxPlayers,e))},e.prototype.setEmptyRoomLiveTime=function(e){this.emptyRoomLiveTime=e},e.prototype.setSuspendedPlayerLiveTime=function(e){this.suspendedPlayerLiveTime=e},e.prototype.setPlugins=function(e){this.plugins=e},e.prototype.setUniqueUserId=function(e){this.uniqueUserId=e},e.prototype.setPropsListedInLobby=function(e){this._propsListedInLobby=e},e.prototype._setLBC=function(e){this.loadBalancingClient=e},e}(h.RoomInfo=l);h.Room=t;var e=function(){function u(e,t,o){this.appId=t,this.appVersion=o,this.autoJoinLobby=!0,this.connectOptions={},this.createRoomOptions={},this.joinRoomOptions={},this.roomInfos=new Array,this.roomInfosDict={},this.actors={},this.actorsArray=[],this.lowestActorId=0,this.userAuthType=h.Constants.CustomAuthenticationType.None,this.userAuthParameters="",this.userAuthData="",this.lobbyStatsRequestList=new Array,this.state=u.State.Uninitialized,this.logger=new Exitgames.Common.Logger("Client:"),this.validNextState={};if("number"==typeof e)switch(this.connectionProtocol=e){case m.ConnectionProtocol.Ws:this.masterServerAddress="ws://app-eu.exitgamescloud.com:9090",this.nameServerAddress="ws://ns.exitgames.com:9093";break;case m.ConnectionProtocol.Wss:this.masterServerAddress="wss://app-eu.exitgamescloud.com:19090",this.nameServerAddress="wss://ns.exitgames.com:19093";break;default:var n="wrong_protocol_error";this.masterServerAddress=n,this.nameServerAddress=n,this.logger.error("Wrong protocol: ",e)}else if("string"==typeof e){this.connectionProtocol=m.ConnectionProtocol.Ws;var r=e;this.masterServerAddress=r,this.nameServerAddress=r}else{this.connectionProtocol=m.ConnectionProtocol.Ws;var s="wrong_protocol_type_error";this.masterServerAddress=s,this.nameServerAddress=s,this.logger.error("Wrong protocol type: ",typeof e)}this.initValidNextState(),this.currentRoom=this.roomFactoryInternal(""),this._myActor=this.actorFactoryInternal("",-1,!0),this.addActor(this._myActor)}return u.prototype.onStateChange=function(e){},u.prototype.onError=function(e,t){},u.prototype.onOperationResponse=function(e,t,o,n){},u.prototype.onEvent=function(e,t,o){},u.prototype.onRoomList=function(e){},u.prototype.onRoomListUpdate=function(e,t,o,n){},u.prototype.onMyRoomPropertiesChange=function(){},u.prototype.onActorPropertiesChange=function(e){},u.prototype.onJoinRoom=function(e){},u.prototype.onActorJoin=function(e){},u.prototype.onActorLeave=function(e,t){},u.prototype.onActorSuspend=function(e){},u.prototype.onFindFriendsResult=function(e,t,o){},u.prototype.onLobbyStats=function(e,t,o){},u.prototype.onAppStats=function(e,t,o){},u.prototype.onGetRegionsResult=function(e,t,o){},u.prototype.onWebRpcResult=function(e,t,o,n,r){},u.prototype.roomFactory=function(e){return new t(e)},u.prototype.actorFactory=function(e,t,o){return new r(e,t,o)},u.prototype.myActor=function(){return this._myActor},u.prototype.myRoom=function(){return this.currentRoom},u.prototype.myRoomActors=function(){return this.actors},u.prototype.myRoomActorCount=function(){return this.actorsArray.length},u.prototype.myRoomActorsArray=function(){return this.actorsArray},u.prototype.myRoomMasterActorNr=function(){return this.myRoom().masterClientId?this.myRoom().masterClientId:this.lowestActorId},u.prototype.lastRtt=function(){return this.gamePeer&&this.gamePeer.getLastRtt()},u.prototype.roomFactoryInternal=function(e){void 0===e&&(e="");var t=this.roomFactory(e);return t._setLBC(this),t},u.prototype.actorFactoryInternal=function(e,t,o){void 0===e&&(e=""),void 0===t&&(t=-1),void 0===o&&(o=!1);var n=this.actorFactory(e,t,o);return n._setLBC(this),n},u.prototype.setNameServerAddress=function(e){this.nameServerAddress=e},u.prototype.getNameServerAddress=function(){return this.nameServerAddress},u.prototype.setMasterServerAddress=function(e){this.masterServerAddress=e},u.prototype.getMasterServerAddress=function(){return this.nameServerAddress},u.prototype.setUserId=function(e){this.userId=e},u.prototype.getUserId=function(){return this.userId},u.prototype.setCustomAuthentication=function(e,t,o){void 0===t&&(t=m.LoadBalancing.Constants.CustomAuthenticationType.Custom),this.userAuthType=t,this.userAuthParameters=e,this.userAuthData=o},u.prototype.connect=function(e){if("boolean"==typeof e&&(e=e?{keepMasterConnection:!0}:{keepMasterConnection:!1}),e||(e={}),this.checkNextState(u.State.ConnectingToMasterserver,!0)){for(var t in this.changeState(u.State.ConnectingToMasterserver),this.logger.info("Connecting to Master",this.masterServerAddress),this.connectOptions={},e)this.connectOptions[t]=e[t];return this.masterPeer=new i(this,o(this.masterServerAddress,this.connectionProtocol),""),this.initMasterPeer(this.masterPeer),this.masterPeer.connect(this.appId),!0}return!1},u.prototype.connectToNameServer=function(e){if(e||(e={}),this.checkNextState(u.State.ConnectingToNameServer,!0)){for(var t in this.changeState(u.State.ConnectingToNameServer),this.logger.info("Connecting to NameServer",this.nameServerAddress),this.connectOptions={},e)this.connectOptions[t]=e[t];return this.nameServerPeer=new a(this,o(this.nameServerAddress,this.connectionProtocol),""),this.initNameServerPeer(this.nameServerPeer),this.nameServerPeer.connect(this.appId),!0}return!1},u.prototype.fillCreateRoomOptions=function(e,t){var o={};if(void 0!==(t=t||{}).isVisible&&(o[h.Constants.GameProperties.IsVisible]=t.isVisible),void 0!==t.isOpen&&(o[h.Constants.GameProperties.IsOpen]=t.isOpen),void 0!==t.maxPlayers&&(o[h.Constants.GameProperties.MaxPlayers]=t.maxPlayers),void 0!==t.propsListedInLobby&&(o[h.Constants.GameProperties.PropsListedInLobby]=m.TypeExt.String(t.propsListedInLobby)),void 0!==t.customGameProperties)for(var n in t.customGameProperties)o[n]=t.customGameProperties[n];e.push(h.Constants.ParameterCode.GameProperties,o),e.push(h.Constants.ParameterCode.CleanupCacheOnLeave,!0),e.push(h.Constants.ParameterCode.Broadcast,!0),void 0!==t.emptyRoomLiveTime&&e.push(h.Constants.ParameterCode.EmptyRoomTTL,m.TypeExt.Int(t.emptyRoomLiveTime)),void 0!==t.suspendedPlayerLiveTime&&e.push(h.Constants.ParameterCode.PlayerTTL,m.TypeExt.Int(t.suspendedPlayerLiveTime)),void 0!==t.plugins&&e.push(h.Constants.ParameterCode.Plugins,t.plugins),void 0!==t.uniqueUserId&&e.push(h.Constants.ParameterCode.CheckUserOnJoin,t.uniqueUserId),t.lobbyName&&(e.push(h.Constants.ParameterCode.LobbyName),e.push(t.lobbyName),null!=t.lobbyType&&(e.push(h.Constants.ParameterCode.LobbyType),e.push(t.lobbyType)))},u.prototype.createRoomFromMy=function(e,t){return this.currentRoom.name=e||"",t=this.copyCreateOptionsFromMyRoom(t),this.createRoomInternal(this.masterPeer,t)},u.prototype.copyCreateOptionsFromMyRoom=function(e){return(e=e||{}).isVisible=this.currentRoom.isVisible,e.isOpen=this.currentRoom.isOpen,e.maxPlayers=this.currentRoom.maxPlayers,e.customGameProperties=this.currentRoom._customProperties,e.propsListedInLobby=this.currentRoom._propsListedInLobby,e.emptyRoomLiveTime=this.currentRoom.emptyRoomLiveTime,e.suspendedPlayerLiveTime=this.currentRoom.suspendedPlayerLiveTime,e.plugins=this.currentRoom.plugins,e.uniqueUserId=this.currentRoom.uniqueUserId,e},u.prototype.createRoom=function(e,t){return this.currentRoom=this.roomFactoryInternal(e||""),this.createRoomInternal(this.masterPeer,t)},u.prototype.joinRoom=function(e,t,o){var n=[];return t&&(t.createIfNotExists&&(n.push(h.Constants.ParameterCode.JoinMode,u.JoinMode.CreateIfNotExists),this.fillCreateRoomOptions(n,o)),t.joinToken&&(n.push(h.Constants.ParameterCode.ActorNr,parseInt(t.joinToken)),n.push(h.Constants.ParameterCode.JoinMode,u.JoinMode.Rejoin))),this.currentRoom=this.roomFactoryInternal(e),n.push(h.Constants.ParameterCode.RoomName,e),this.joinRoomOptions=t||{},this.createRoomOptions=o||{},this.logger.info("Join Room",e,t,o,"..."),this.masterPeer.sendOperation(h.Constants.OperationCode.JoinGame,n),!0},u.prototype.joinRandomRoom=function(e){var t=[];if(e){null!=e.matchingType&&e.matchingType!=h.Constants.MatchmakingMode.FillRoom&&(t.push(h.Constants.ParameterCode.MatchMakingType),t.push(e.matchingType));var o={},n=!1;if(null!=e.expectedCustomRoomProperties)for(var r in e.expectedCustomRoomProperties)o[r]=e.expectedCustomRoomProperties[r],n=!0;null!=e.expectedMaxPlayers&&0<e.expectedMaxPlayers&&(o[h.Constants.GameProperties.MaxPlayers]=e.expectedMaxPlayers,n=!0),n&&(t.push(h.Constants.ParameterCode.GameProperties),t.push(o)),e.lobbyName&&(t.push(h.Constants.ParameterCode.LobbyName),t.push(e.lobbyName),null!=e.lobbyType&&(t.push(h.Constants.ParameterCode.LobbyType),t.push(e.lobbyType))),e.sqlLobbyFilter&&(t.push(h.Constants.ParameterCode.Data),t.push(e.sqlLobbyFilter))}return this.logger.info("Join Random Room",e&&e.lobbyName,e&&e.lobbyType,"..."),this.masterPeer.sendOperation(h.Constants.OperationCode.JoinRandomGame,t),!0},u.prototype._setPropertiesOfRoom=function(e,t,o){var n=[];n.push(h.Constants.ParameterCode.Properties),n.push(e),n.push(h.Constants.ParameterCode.Broadcast),n.push(!0),t&&(n.push(h.Constants.ParameterCode.Forward),n.push(!0)),o&&(n.push(h.Constants.ParameterCode.ExpectedValues),n.push(o)),this.gamePeer.sendOperation(h.Constants.OperationCode.SetProperties,n)},u.prototype._setPropertiesOfActor=function(e,t,o,n){var r=[];r.push(h.Constants.ParameterCode.ActorNr),r.push(e),r.push(h.Constants.ParameterCode.Properties),r.push(t),r.push(h.Constants.ParameterCode.Broadcast),r.push(!0),o&&(r.push(h.Constants.ParameterCode.Forward),r.push(!0)),n&&(r.push(h.Constants.ParameterCode.ExpectedValues),r.push(n)),this.gamePeer.sendOperation(h.Constants.OperationCode.SetProperties,r)},u.prototype.disconnect=function(){this.nameServerPeer&&this.nameServerPeer.disconnect(),this._cleanupNameServerPeerData(),this.masterPeer&&this.masterPeer.disconnect(),this._cleanupMasterPeerData(),this.gamePeer&&this.gamePeer.disconnect(),this._cleanupGamePeerData(),this.changeState(u.State.Disconnected)},u.prototype.suspendRoom=function(){this.isJoinedToRoom()&&(this.gamePeer&&this.gamePeer.disconnect(),this._cleanupGamePeerData(),this.isConnectedToMaster()?this.changeState(u.State.JoinedLobby):(this.changeState(u.State.Disconnected),this.connect(this.connectOptions)))},u.prototype.leaveRoom=function(){this.isJoinedToRoom()&&(this.gamePeer&&(this.gamePeer.sendOperation(h.Constants.OperationCode.Leave),this.gamePeerWaitingForDisconnect=!0),this._cleanupGamePeerData(),this.isConnectedToMaster()?this.changeState(u.State.JoinedLobby):(this.changeState(u.State.Disconnected),this.connect(this.connectOptions)))},u.prototype.raiseEvent=function(e,t,o){this.isJoinedToRoom()&&this.gamePeer.raiseEvent(e,t,o)},u.prototype.changeGroups=function(e,t){this.isJoinedToRoom()&&(this.logger.debug("Group change:",e,t),this.gamePeer.changeGroups(e,t))},u.prototype.findFriends=function(e){if(this.isConnectedToMaster())if(e&&"object"==typeof e){this.findFriendsRequestList=new Array;for(var t=0;t<e.length;++t){if("string"!=typeof e[t])return this.logger.error("FindFriends request error:","Friend name is not a string",t),void this.onFindFriendsResult(-1,"Friend name is not a string "+t,{});this.findFriendsRequestList[t]=e[t]}this.logger.debug("Find friends:",e),this.masterPeer.findFriends(this.findFriendsRequestList)}else this.logger.error("FindFriends request error:","Parameter is not an array"),this.onFindFriendsResult(-1,"Parameter is not an array",{});else this.logger.error("FindFriends request error:","Not connected to Master"),this.onFindFriendsResult(u.PeerErrorCode.MasterError,"Not connected to Master",{})},u.prototype.requestLobbyStats=function(e){if(this.isConnectedToMaster()){if(this.lobbyStatsRequestList=new Array,e){if("object"!=typeof e)return void this.requestLobbyStatsErr("Parameter is not an array");for(var t=0;t<e.length;++t){var o=e[t];if("object"!=typeof o)return void this.requestLobbyStatsErr("Lobby id is not an array",t);var n,r=o[0];if(!r)return void this.requestLobbyStatsErr("Lobby name is empty",t);if(void 0===o[1])n=h.Constants.LobbyType.Default;else{if("number"!=typeof o[1])return void this.requestLobbyStatsErr("Lobby type is invalid",t);n=o[1]}this.lobbyStatsRequestList[t]=[r.toString(),n]}}this.masterPeer.requestLobbyStats(this.lobbyStatsRequestList)}else this.logger.error("LobbyState request error:","Not connected to Master"),this.onLobbyStats(u.PeerErrorCode.MasterError,"Not connected to Master",[])},u.prototype.requestLobbyStatsErr=function(e,t){void 0===t&&(t=""),this.logger.error("LobbyState request error:",e,t),this.onLobbyStats(-1,e+" "+t,[])},u.prototype.getRegions=function(){this.isConnectedToNameServer()?(this.logger.debug("GetRegions..."),this.nameServerPeer.getRegions(this.appId)):(this.logger.error("GetRegions request error:","Not connected to NameServer"),this.onGetRegionsResult(u.PeerErrorCode.NameServerError,"Not connected to NameServer",{}))},u.prototype.webRpc=function(e,t){this.isConnectedToMaster()?(this.logger.debug("WebRpc..."),this.masterPeer.webRpc(e,t)):this.isJoinedToRoom()?(this.logger.debug("WebRpc..."),this.gamePeer.webRpc(e,t)):(this.logger.error("WebRpc request error:","Connected to neither Master nor Game server"),this.onWebRpcResult(u.PeerErrorCode.MasterError,"Connected to neither Master nor Game server",e,0,{}))},u.prototype.connectToRegionMaster=function(e){return this.isConnectedToNameServer()?(this.logger.debug("Connecting to Region Master",e,"..."),this.nameServerPeer.opAuth(this.appId,this.appVersion,this.userAuthType,this.userAuthParameters,this.userAuthData,this.userId,e),!0):!!this.connectToNameServer({region:e})||(this.logger.error("Connecting to Region Master error:","Not connected to NameServer"),!1)},u.prototype.isConnectedToMaster=function(){return this.masterPeer&&this.masterPeer.isConnected()},u.prototype.isConnectedToNameServer=function(){return this.nameServerPeer&&this.nameServerPeer.isConnected()},u.prototype.isInLobby=function(){return this.state==u.State.JoinedLobby},u.prototype.isJoinedToRoom=function(){return this.state==u.State.Joined},u.prototype.isConnectedToGame=function(){return this.isJoinedToRoom()},u.prototype.availableRooms=function(){return this.roomInfos},u.prototype.setLogLevel=function(e){this.logger.setLevel(e),this.nameServerPeer&&this.nameServerPeer.setLogLevel(e),this.masterPeer&&this.masterPeer.setLogLevel(e),this.gamePeer&&this.gamePeer.setLogLevel(e)},u.prototype.addRoom=function(e){this.roomInfos.push(e),this.roomInfosDict[e.name]=e},u.prototype.clearRooms=function(){this.roomInfos=new Array,this.roomInfosDict={}},u.prototype.purgeRemovedRooms=function(){for(var e in this.roomInfos=this.roomInfos.filter(function(e){return!e.removed}),this.roomInfosDict)this.roomInfosDict[e].removed&&delete this.roomInfosDict[e]},u.prototype.addActor=function(e){this.actors[e.actorNr]=e,this.actorsArray.push(e),this.currentRoom.playerCount=this.actorsArray.length,(0==this.lowestActorId||this.lowestActorId>e.actorNr)&&(this.lowestActorId=e.actorNr)},u.prototype.removeActor=function(t){delete this.actors[t],this.actorsArray=this.actorsArray.filter(function(e){return e.actorNr!=t}),this.currentRoom.playerCount=this.actorsArray.length,this.lowestActorId==t&&(0<this.actorsArray.length?this.lowestActorId=this.actorsArray.reduce(function(e,t){return e.actorNr<t.actorNr?e:t}).actorNr:this.lowestActorId=0)},u.prototype.clearActors=function(){this.actors={},this.actorsArray=[],this.currentRoom.playerCount=0,this.lowestActorId=0},u.prototype.changeState=function(e){this.logger.info("State:",u.StateToName(this.state),"->",u.StateToName(e)),this.state=e,this.onStateChange(e)},u.prototype.createRoomInternal=function(e,t){var o=[];this.currentRoom.name&&o.push(h.Constants.ParameterCode.RoomName,this.currentRoom.name),this.fillCreateRoomOptions(o,t),e===this.masterPeer&&(this.createRoomOptions=t),e===this.gamePeer&&(o.push(h.Constants.ParameterCode.PlayerProperties),o.push(this._myActor._getAllProperties())),(e==this.gamePeer?this.gamePeer._logger:this.masterPeer._logger).info("Create Room",t&&t.lobbyName,t&&t.lobbyType,"..."),e.sendOperation(h.Constants.OperationCode.CreateGame,o)},u.prototype.updateUserIdAndNickname=function(e,t){var o=e[h.Constants.ParameterCode.UserId];null!=o&&(this.setUserId(o),t.info("Setting userId sent by server:",o));var n=e[h.Constants.ParameterCode.Nickname];null!=n&&(this.myActor().setName(n),t.info("Setting nickname sent by server:",n))},u.prototype.initNameServerPeer=function(s){var a=this;s.setLogLevel(this.logger.getLevel()),s.addPeerStatusListener(m.PhotonPeer.StatusCodes.error,function(){a.changeState(u.State.Error),a._onErrorInternal(u.PeerErrorCode.NameServerError,"NameServer peer error")}),s.addPeerStatusListener(m.PhotonPeer.StatusCodes.connectFailed,function(){a.changeState(u.State.Error),a._onErrorInternal(u.PeerErrorCode.NameServerConnectFailed,"NameServer peer connect failed. "+a.nameServerAddress)}),s.addPeerStatusListener(m.PhotonPeer.StatusCodes.timeout,function(){a.changeState(u.State.Error),a._onErrorInternal(u.PeerErrorCode.NameServerTimeout,"NameServer peer timeout")}),s.addPeerStatusListener(m.PhotonPeer.StatusCodes.connecting,function(){}),s.addPeerStatusListener(m.PhotonPeer.StatusCodes.connect,function(){s._logger.info("Connected"),a.changeState(u.State.ConnectedToNameServer),null!=a.connectOptions.region&&s.opAuth(a.appId,a.appVersion,a.userAuthType,a.userAuthParameters,a.userAuthData,a.userId,a.connectOptions.region)}),s.addPeerStatusListener(m.PhotonPeer.StatusCodes.disconnect,function(){s==a.nameServerPeer&&(a._cleanupNameServerPeerData(),s._logger.info("Disconnected"))}),s.addPeerStatusListener(m.PhotonPeer.StatusCodes.connectClosed,function(){s._logger.info("Server closed connection"),a.changeState(u.State.Error),a._onErrorInternal(u.PeerErrorCode.NameServerConnectClosed,"NameServer server closed connection")}),s.addResponseListener(h.Constants.OperationCode.GetRegions,function(e){s._logger.debug("resp GetRegions",e);var t={};if(0==e.errCode){var o=e.vals[h.Constants.ParameterCode.Region],n=e.vals[h.Constants.ParameterCode.Address];for(var r in o)t[o[r]]=n[r]}else s._logger.error("GetRegions request error.",e.errCode);a.onGetRegionsResult(e.errCode,e.errMsg,t)}),s.addResponseListener(h.Constants.OperationCode.Authenticate,function(e){s._logger.debug("resp Authenticate",e),0==e.errCode?(s._logger.info("Authenticated"),s.disconnect(),a.updateUserIdAndNickname(e.vals,s._logger),a.masterServerAddress=e.vals[h.Constants.ParameterCode.Address],s._logger.info("Connecting to Master server",a.masterServerAddress,"..."),a.connect({userAuthSecret:e.vals[h.Constants.ParameterCode.Secret]})):(a.changeState(u.State.Error),a._onErrorInternal(u.PeerErrorCode.NameServerAuthenticationFailed,"NameServer authentication failed: "+e.errCode+" "+e.errMsg))})},u.prototype.initMasterPeer=function(p){var d=this;p.setLogLevel(this.logger.getLevel()),p.addPeerStatusListener(m.PhotonPeer.StatusCodes.error,function(){d.changeState(u.State.Error),d._onErrorInternal(u.PeerErrorCode.MasterError,"Master peer error")}),p.addPeerStatusListener(m.PhotonPeer.StatusCodes.connectFailed,function(){d.changeState(u.State.Error),d._onErrorInternal(u.PeerErrorCode.MasterConnectFailed,"Master peer connect failed: "+d.masterServerAddress)}),p.addPeerStatusListener(m.PhotonPeer.StatusCodes.timeout,function(){d.changeState(u.State.Error),d._onErrorInternal(u.PeerErrorCode.MasterTimeout,"Master peer error timeout")}),p.addPeerStatusListener(m.PhotonPeer.StatusCodes.connecting,function(){}),p.addPeerStatusListener(m.PhotonPeer.StatusCodes.connect,function(){p._logger.info("Connected");var e=[];d.connectOptions.userAuthSecret?(e.push(h.Constants.ParameterCode.Secret,d.connectOptions.userAuthSecret),p.sendOperation(h.Constants.OperationCode.Authenticate,e),p._logger.info("Authenticate with secret...")):(e.push(h.Constants.ParameterCode.ApplicationId),e.push(d.appId),e.push(h.Constants.ParameterCode.AppVersion),e.push(d.appVersion),d.userAuthType!=h.Constants.CustomAuthenticationType.None&&(e.push(h.Constants.ParameterCode.ClientAuthenticationType,m.TypeExt.Byte(d.userAuthType)),e.push(h.Constants.ParameterCode.ClientAuthenticationParams,d.userAuthParameters),d.userAuthData&&e.push(h.Constants.ParameterCode.ClientAuthenticationData,d.userAuthData)),d.userId&&e.push(h.Constants.ParameterCode.UserId,d.userId),d.connectOptions.lobbyStats&&e.push(h.Constants.ParameterCode.LobbyStats,!0),p.sendOperation(h.Constants.OperationCode.Authenticate,e),p._logger.info("Authenticate..."))}),p.addPeerStatusListener(m.PhotonPeer.StatusCodes.disconnect,function(){p==d.masterPeer&&(d._cleanupMasterPeerData(),p._logger.info("Disconnected"))}),p.addPeerStatusListener(m.PhotonPeer.StatusCodes.connectClosed,function(){p._logger.info("Server closed connection"),d.changeState(u.State.Error),d._onErrorInternal(u.PeerErrorCode.MasterConnectClosed,"Master server closed connection")}),p.addEventListener(h.Constants.EventCode.GameList,function(e){var t=e.vals[h.Constants.ParameterCode.GameList];for(var o in d.clearRooms(),t){var n=new l(o);n._updateFromProps(t[o]),d.addRoom(n)}d.onRoomList(d.roomInfos),p._logger.debug("ev GameList",d.roomInfos,t)}),p.addEventListener(h.Constants.EventCode.GameListUpdate,function(e){var t=e.vals[h.Constants.ParameterCode.GameList],o=new Array,n=new Array,r=new Array;for(var s in t){var a=d.roomInfos.filter(function(e){return e.name==s});if(0<a.length){var i=a[0];i._updateFromProps(t[s]),i.removed?r.push(i):o.push(i)}else{var c=new l(s);c._updateFromProps(t[s]),d.addRoom(c),n.push(i)}}d.purgeRemovedRooms(),d.onRoomListUpdate(d.roomInfos,o,n,r),p._logger.debug("ev GameListUpdate:",d.roomInfos,"u:",o,"a:",n,"r:",r,t)}),p.addResponseListener(h.Constants.OperationCode.Authenticate,function(e){if(p._logger.debug("resp Authenticate",e),e.errCode)d.changeState(u.State.Error),d._onErrorInternal(u.PeerErrorCode.MasterAuthenticationFailed,"Master authentication failed: "+e.errCode+" "+e.errMsg);else{p._logger.info("Authenticated"),d.updateUserIdAndNickname(e.vals,p._logger),null!=e.vals[h.Constants.ParameterCode.Secret]&&(d.connectOptions.userAuthSecret=e.vals[h.Constants.ParameterCode.Secret]),d.changeState(u.State.ConnectedToMaster);var t=[];d.connectOptions.lobbyName&&(t.push(h.Constants.ParameterCode.LobbyName),t.push(d.connectOptions.lobbyName),null!=d.connectOptions.lobbyType&&(t.push(h.Constants.ParameterCode.LobbyType),t.push(d.connectOptions.lobbyType))),d.autoJoinLobby&&(p.sendOperation(h.Constants.OperationCode.JoinLobby,t),p._logger.info("Join Lobby",d.connectOptions.lobbyName,d.connectOptions.lobbyType,"..."))}}),p.addResponseListener(h.Constants.OperationCode.JoinLobby,function(e){p._logger.debug("resp JoinLobby",e),e.errCode||(p._logger.info("Joined to Lobby"),d.changeState(u.State.JoinedLobby)),d._onOperationResponseInternal2(h.Constants.OperationCode.JoinLobby,e)}),p.addResponseListener(h.Constants.OperationCode.CreateGame,function(e){p._logger.debug("resp CreateGame",e),e.errCode||(d.currentRoom._updateFromMasterResponse(e.vals),p._logger.debug("Created/Joined "+d.currentRoom.name),d.connectToGameServer(h.Constants.OperationCode.CreateGame)),d._onOperationResponseInternal2(h.Constants.OperationCode.CreateGame,e)}),p.addResponseListener(h.Constants.OperationCode.JoinGame,function(e){p._logger.debug("resp JoinGame",e),e.errCode||(d.currentRoom._updateFromMasterResponse(e.vals),p._logger.debug("Joined "+d.currentRoom.name),d.connectToGameServer(h.Constants.OperationCode.JoinGame)),d._onOperationResponseInternal2(h.Constants.OperationCode.JoinGame,e)}),p.addResponseListener(h.Constants.OperationCode.JoinRandomGame,function(e){p._logger.debug("resp JoinRandomGame",e),e.errCode||(d.currentRoom._updateFromMasterResponse(e.vals),p._logger.debug("Joined "+d.currentRoom.name),d.connectToGameServer(h.Constants.OperationCode.JoinRandomGame)),d._onOperationResponseInternal2(h.Constants.OperationCode.JoinRandomGame,e)}),p.addResponseListener(h.Constants.OperationCode.FindFriends,function(e){p._logger.debug("resp FindFriends",e);var t={};if(e.errCode)p._logger.error("FindFriends request error:",e.errCode);else for(var o=e.vals[h.Constants.ParameterCode.FindFriendsResponseOnlineList]||{},n=e.vals[h.Constants.ParameterCode.FindFriendsResponseRoomIdList]||{},r=0;r<d.findFriendsRequestList.length;++r){var s=d.findFriendsRequestList[r];s&&(t[s]={online:o[r],roomId:n[r]})}d.onFindFriendsResult(e.errCode,e.errMsg,t)}),p.addResponseListener(h.Constants.OperationCode.LobbyStats,function(e){p._logger.debug("resp LobbyStats",e);var t=new Array;if(e.errCode)p._logger.error("LobbyStats request error:",e.errCode);else{var o=e.vals[h.Constants.ParameterCode.LobbyName],n=e.vals[h.Constants.ParameterCode.LobbyType]||{},r=e.vals[h.Constants.ParameterCode.PeerCount]||{},s=e.vals[h.Constants.ParameterCode.GameCount]||{};if(o)for(var a=0;a<o.length;++a)t[a]={lobbyName:o[a],lobbyType:n[a],peerCount:r[a],gameCount:s[a]};else for(a=0;a<d.lobbyStatsRequestList.length;++a){var i=d.lobbyStatsRequestList[a];t[a]={lobbyName:i[0],lobbyType:i[1],peerCount:r[a],gameCount:s[a]}}}d.onLobbyStats(e.errCode,e.errMsg,t)}),p.addEventListener(h.Constants.EventCode.LobbyStats,function(e){p._logger.debug("ev LobbyStats",e);var t=new Array,o=e.vals[h.Constants.ParameterCode.LobbyName],n=e.vals[h.Constants.ParameterCode.LobbyType]||{},r=e.vals[h.Constants.ParameterCode.PeerCount]||{},s=e.vals[h.Constants.ParameterCode.GameCount]||{};if(o)for(var a=0;a<o.length;++a)t[a]={lobbyName:o[a],lobbyType:n[a],peerCount:r[a],gameCount:s[a]};d.onLobbyStats(0,"",t)}),p.addEventListener(h.Constants.EventCode.AppStats,function(e){p._logger.debug("ev AppStats",e);var t={peerCount:e.vals[h.Constants.ParameterCode.PeerCount],masterPeerCount:e.vals[h.Constants.ParameterCode.MasterPeerCount],gameCount:e.vals[h.Constants.ParameterCode.GameCount]};d.onAppStats(0,"",t)}),p.addResponseListener(h.Constants.OperationCode.Rpc,p.webRpcHandler(this))},u.prototype.connectToGameServer=function(e){return this.connectOptions.keepMasterConnection||this.masterPeer.disconnect(),!!this.checkNextState(u.State.ConnectingToGameserver,!0)&&(this.logger.info("Connecting to Game",this.currentRoom.address),this.gamePeer=new c(this,o(this.currentRoom.address,this.connectionProtocol),""),this.gamePeerWaitingForDisconnect=!1,this.initGamePeer(this.gamePeer,e),this.gamePeer.connect(this.appId),this.changeState(u.State.ConnectingToGameserver),!0)},u.prototype.initGamePeer=function(c,o){var p=this;c.setLogLevel(this.logger.getLevel()),c.addPeerStatusListener(m.PhotonPeer.StatusCodes.error,function(){p.changeState(u.State.Error),p._onErrorInternal(u.PeerErrorCode.GameError,"Game peer error")}),c.addPeerStatusListener(m.PhotonPeer.StatusCodes.connectFailed,function(){p.changeState(u.State.Error),p._onErrorInternal(u.PeerErrorCode.GameConnectFailed,"Game peer connect failed: "+p.currentRoom.address)}),c.addPeerStatusListener(m.PhotonPeer.StatusCodes.timeout,function(){p.changeState(u.State.Error),p._onErrorInternal(u.PeerErrorCode.GameTimeout,"Game peer timeout")}),c.addPeerStatusListener(m.PhotonPeer.StatusCodes.connect,function(){c._logger.info("Connected");var e=[];e.push(h.Constants.ParameterCode.ApplicationId),e.push(p.appId),e.push(h.Constants.ParameterCode.AppVersion),e.push(p.appVersion),null!=p.connectOptions.userAuthSecret&&(e.push(h.Constants.ParameterCode.Secret),e.push(p.connectOptions.userAuthSecret)),p.userAuthType!=h.Constants.CustomAuthenticationType.None&&(e.push(h.Constants.ParameterCode.ClientAuthenticationType),e.push(m.TypeExt.Byte(p.userAuthType))),p.userId&&e.push(h.Constants.ParameterCode.UserId,p.userId),c.sendOperation(h.Constants.OperationCode.Authenticate,e),c._logger.info("Authenticate...")}),c.addPeerStatusListener(m.PhotonPeer.StatusCodes.disconnect,function(){c==p.gamePeer&&(p._cleanupGamePeerData(),c._logger.info("Disconnected"))}),c.addPeerStatusListener(m.PhotonPeer.StatusCodes.connectClosed,function(){c._logger.info("Server closed connection"),p.gamePeerWaitingForDisconnect||(p.changeState(u.State.Error),p._onErrorInternal(u.PeerErrorCode.MasterConnectClosed,"Game server closed connection"))}),c.addResponseListener(h.Constants.OperationCode.Authenticate,function(e){if(c._logger.debug("resp Authenticate",e),e.errCode)p.changeState(u.State.Error),p._onErrorInternal(u.PeerErrorCode.GameAuthenticationFailed,"Game authentication failed: "+e.errCode+" "+e.errMsg);else{if(c._logger.info("Authenticated"),c._logger.info("Connected"),o==h.Constants.OperationCode.CreateGame)p.createRoomInternal(c,p.createRoomOptions);else{var t=[];t.push(h.Constants.ParameterCode.RoomName),t.push(p.currentRoom.name),t.push(h.Constants.ParameterCode.Broadcast),t.push(!0),t.push(h.Constants.ParameterCode.PlayerProperties),t.push(p._myActor._getAllProperties()),o==h.Constants.OperationCode.JoinGame&&(p.joinRoomOptions.createIfNotExists&&(t.push(h.Constants.ParameterCode.JoinMode,u.JoinMode.CreateIfNotExists),p.fillCreateRoomOptions(t,p.createRoomOptions)),p.joinRoomOptions.joinToken&&(t.push(h.Constants.ParameterCode.ActorNr,parseInt(p.joinRoomOptions.joinToken)),t.push(h.Constants.ParameterCode.JoinMode,u.JoinMode.Rejoin))),c.sendOperation(h.Constants.OperationCode.JoinGame,t)}p.changeState(u.State.ConnectedToGameserver)}}),c.addResponseListener(h.Constants.OperationCode.CreateGame,function(e){c._logger.debug("resp CreateGame",e),e.errCode||(p._myActor._updateMyActorFromResponse(e.vals),c._logger.info("myActor: ",p._myActor),p.currentRoom._updateFromProps(e.vals[h.Constants.ParameterCode.GameProperties]),p.clearActors(),p.addActor(p._myActor),p.changeState(u.State.Joined),p.onJoinRoom(!0)),p._onOperationResponseInternal2(h.Constants.OperationCode.CreateGame,e)}),c.addResponseListener(h.Constants.OperationCode.JoinGame,function(e){if(c._logger.debug("resp JoinGame",e),!e.errCode){p._myActor._updateMyActorFromResponse(e.vals),c._logger.info("myActor: ",p._myActor),p.clearActors(),p.addActor(p._myActor);var t=e.vals[h.Constants.ParameterCode.ActorList],o=e.vals[h.Constants.ParameterCode.PlayerProperties];if(void 0!==t)for(var n in t){var r,s,a,i=t[n];void 0!==o&&(r=o[i]),void 0!==r&&(s=r[h.Constants.ActorProperties.PlayerName]),i==p._myActor.actorNr?a=p._myActor:(a=p.actorFactoryInternal(s,i),p.addActor(a)),void 0!==r&&a._updateCustomProperties(r)}p.currentRoom._updateFromProps(e.vals[h.Constants.ParameterCode.GameProperties]),p.changeState(u.State.Joined),p.onJoinRoom(!1)}p._onOperationResponseInternal2(h.Constants.OperationCode.JoinGame,e)}),c.addResponseListener(h.Constants.OperationCode.SetProperties,function(e){c._logger.debug("resp SetProperties",e),p._onOperationResponseInternal2(h.Constants.OperationCode.SetProperties,e)}),c.addResponseListener(h.Constants.OperationCode.Leave,function(e){c._logger.debug("resp Leave",e),c.disconnect(),p._onOperationResponseInternal2(h.Constants.OperationCode.Leave,e)}),c.addResponseListener(h.Constants.OperationCode.Rpc,c.webRpcHandler(this)),c.addEventListener(h.Constants.EventCode.Join,function(e){if(c._logger.debug("ev Join",e),r._getActorNrFromResponse(e.vals)===p._myActor.actorNr)p._myActor._updateFromResponse(e.vals),p.onActorJoin(p._myActor);else{var t=p.actorFactoryInternal();t._updateFromResponse(e.vals),p.addActor(t),p.onActorJoin(t)}}),c.addEventListener(h.Constants.EventCode.Leave,function(e){c._logger.debug("ev Leave",e),p.myRoom()._updateFromEvent(e.vals);var t=r._getActorNrFromResponse(e.vals);if(t&&p.actors[t]){var o=p.actors[t];e.vals[h.Constants.ParameterCode.IsInactive]?(o._setSuspended(!0),p.onActorSuspend(o)):(p.removeActor(t),p.onActorLeave(o,!1))}}),c.addEventListener(h.Constants.EventCode.Disconnect,function(e){c._logger.debug("ev Disconnect",e);var t=r._getActorNrFromResponse(e.vals);if(t&&p.actors[t]){var o=p.actors[t];o._setSuspended(!0),p.onActorSuspend(o)}}),c.addEventListener(h.Constants.EventCode.PropertiesChanged,function(e){c._logger.debug("ev PropertiesChanged",e);var t=e.vals[h.Constants.ParameterCode.TargetActorNr];if(void 0!==t&&0<t){if(void 0!==p.actors[t]){var o=p.actors[t];o._updateCustomProperties(e.vals[h.Constants.ParameterCode.Properties]),p.onActorPropertiesChange(o)}}else p.currentRoom._updateFromProps(e.vals[h.Constants.ParameterCode.Properties]),p.onMyRoomPropertiesChange()})},u.prototype._cleanupNameServerPeerData=function(){},u.prototype._cleanupMasterPeerData=function(){},u.prototype._cleanupGamePeerData=function(){for(var e in this.actors)this.onActorLeave(this.actors[e],!0);this.clearActors(),this.addActor(this._myActor)},u.prototype._onOperationResponseInternal2=function(e,t){t.errCode&&this.logger.warn("Operation",e,"error:",t.errMsg,"("+t.errCode+")"),this.onOperationResponse(t.errCode,t.errMsg,e,t.vals)},u.prototype._onErrorInternal=function(e,t){this.logger.error("Error:",e,t),this.onError(e,t)},u.prototype.initValidNextState=function(){this.validNextState[u.State.Error]=[u.State.ConnectingToMasterserver,u.State.ConnectingToNameServer],this.validNextState[u.State.Uninitialized]=[u.State.ConnectingToMasterserver,u.State.ConnectingToNameServer],this.validNextState[u.State.ConnectedToNameServer]=[u.State.ConnectingToMasterserver],this.validNextState[u.State.Disconnected]=[u.State.ConnectingToMasterserver,u.State.ConnectingToNameServer],this.validNextState[u.State.ConnectedToMaster]=[u.State.JoinedLobby],this.validNextState[u.State.JoinedLobby]=[u.State.ConnectingToGameserver],this.validNextState[u.State.ConnectingToGameserver]=[u.State.ConnectedToGameserver],this.validNextState[u.State.ConnectedToGameserver]=[u.State.Joined]},u.prototype.checkNextState=function(e,t){void 0===t&&(t=!1);var o=this.validNextState[this.state],n=o&&0<=o.indexOf(e);if(!n){if(!t)throw new Error("LoadBalancingPeer checkNextState fail: "+u.StateToName(this.state)+" -> "+u.StateToName(e));this.logger.error("LoadBalancingPeer checkNextState fail: "+u.StateToName(this.state)+" -> "+u.StateToName(e))}return n},u.StateToName=function(e){return Exitgames.Common.Util.getEnumKeyByValue(u.State,e)},u.JoinMode={Default:0,CreateIfNotExists:1,Rejoin:2},u.PeerErrorCode={Ok:0,MasterError:1001,MasterConnectFailed:1002,MasterConnectClosed:1003,MasterTimeout:1004,MasterEncryptionEstablishError:1005,MasterAuthenticationFailed:1101,GameError:2001,GameConnectFailed:2002,GameConnectClosed:2003,GameTimeout:2004,GameEncryptionEstablishError:2005,GameAuthenticationFailed:2101,NameServerError:3001,NameServerConnectFailed:3002,NameServerConnectClosed:3003,NameServerTimeout:3004,NameServerEncryptionEstablishError:3005,NameServerAuthenticationFailed:3101},u.State={Error:-1,Uninitialized:0,ConnectingToNameServer:1,ConnectedToNameServer:2,ConnectingToMasterserver:3,ConnectedToMaster:4,JoinedLobby:5,ConnectingToGameserver:6,ConnectedToGameserver:7,Joined:8,Disconnected:10},u}();h.LoadBalancingClient=e;var s=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.webRpc=function(e,t){var o=[];o.push(h.Constants.ParameterCode.UriPath,e),o.push(h.Constants.ParameterCode.RpcCallParams,t),this.sendOperation(h.Constants.OperationCode.Rpc,o)},t.prototype.webRpcHandler=function(r){var s=this;return function(e){var t,o,n;s._logger.debug("resp Rpc",e),0==e.errCode?(t=e.vals[h.Constants.ParameterCode.UriPath],o=e.vals[h.Constants.ParameterCode.RpcCallRetData],n=e.vals[h.Constants.ParameterCode.RpcCallRetCode]):s._logger.error("WebRpc request error:",e.errCode),r.onWebRpcResult(e.errCode,e.errMsg,t,n,o)}},t}(m.PhotonPeer),a=function(r){function e(e,t,o){var n=r.call(this,t,o,"NameServer")||this;return n.client=e,n}return __extends(e,r),e.prototype.onUnhandledEvent=function(e,t){this.client.onEvent(e,t.vals[h.Constants.ParameterCode.CustomEventContent],t.vals[h.Constants.ParameterCode.ActorNr])},e.prototype.onUnhandledResponse=function(e,t){this.client.onOperationResponse(t.errCode,t.errMsg,e,t.vals)},e.prototype.getRegions=function(e){var t=[];t.push(h.Constants.ParameterCode.ApplicationId,e),this.sendOperation(h.Constants.OperationCode.GetRegions,t,!0,0)},e.prototype.opAuth=function(e,t,o,n,r,s,a){var i=[];i.push(h.Constants.ParameterCode.ApplicationId,e),i.push(h.Constants.ParameterCode.AppVersion,t),o!=h.Constants.CustomAuthenticationType.None&&(i.push(h.Constants.ParameterCode.ClientAuthenticationType,m.TypeExt.Byte(o)),i.push(h.Constants.ParameterCode.ClientAuthenticationParams,n),r&&i.push(h.Constants.ParameterCode.ClientAuthenticationData,r)),s&&i.push(h.Constants.ParameterCode.UserId,s),i.push(h.Constants.ParameterCode.Region,a),this.sendOperation(h.Constants.OperationCode.Authenticate,i,!0,0),this._logger.info("Authenticate...")},e}(h.LbcPeer=s);h.NameServerPeer=a;var i=function(r){function e(e,t,o){var n=r.call(this,t,o,"Master")||this;return n.client=e,n}return __extends(e,r),e.prototype.onUnhandledEvent=function(e,t){this.client.onEvent(e,t.vals[h.Constants.ParameterCode.CustomEventContent],t.vals[h.Constants.ParameterCode.ActorNr])},e.prototype.onUnhandledResponse=function(e,t){this.client.onOperationResponse(t.errCode,t.errMsg,e,t.vals)},e.prototype.findFriends=function(e){var t=[];t.push(h.Constants.ParameterCode.FindFriendsRequestList),t.push(e),this.sendOperation(h.Constants.OperationCode.FindFriends,t)},e.prototype.requestLobbyStats=function(e){var t=[];if(e&&0<e.length){for(var o=new Array,n=new Array,r=0;r<e.length;++r)o[r]=e[r][0],n[r]=e[r][1];t.push(h.Constants.ParameterCode.LobbyName),t.push(o),t.push(h.Constants.ParameterCode.LobbyType),t.push(n)}this.sendOperation(h.Constants.OperationCode.LobbyStats,t)},e}(s);h.MasterPeer=i;var c=function(r){function e(e,t,o){var n=r.call(this,t,o,"Game")||this;return n.client=e,n}return __extends(e,r),e.prototype.onUnhandledEvent=function(e,t){this.client.onEvent(e,t.vals[h.Constants.ParameterCode.CustomEventContent],t.vals[h.Constants.ParameterCode.ActorNr])},e.prototype.onUnhandledResponse=function(e,t){this.client.onOperationResponse(t.errCode,t.errMsg,e,t.vals)},e.prototype.raiseEvent=function(e,t,o){if(!this.client.isJoinedToRoom())throw new Error("raiseEvent - Not joined!");this._logger.debug("raiseEvent",e,t,o);var n=[h.Constants.ParameterCode.Code,m.TypeExt.Byte(e),h.Constants.ParameterCode.Data,t];if(o){if(null!=o.receivers&&o.receivers!==h.Constants.ReceiverGroup.Others&&(n.push(h.Constants.ParameterCode.ReceiverGroup),n.push(o.receivers)),null!=o.cache&&o.cache!==h.Constants.EventCaching.DoNotCache&&(n.push(h.Constants.ParameterCode.Cache),n.push(m.TypeExt.Byte(o.cache))),null!=o.interestGroup){if(!this.checkGroupNumber(o.interestGroup))throw new Error("raiseEvent - Group not a number: "+o.interestGroup);n.push(h.Constants.ParameterCode.Group),n.push(m.TypeExt.Byte(o.interestGroup))}null!=o.targetActors&&(n.push(h.Constants.ParameterCode.ActorList),n.push(o.targetActors)),o.webForward&&(n.push(h.Constants.ParameterCode.Forward),n.push(!0))}this.sendOperation(h.Constants.OperationCode.RaiseEvent,n)},e.prototype.changeGroups=function(e,t){var o=[];null!=e&&null!=e&&(this.checkGroupArray(e,"groupsToRemove"),o.push(h.Constants.ParameterCode.Remove),o.push(m.TypeExt.Byte(e))),null!=t&&null!=t&&(this.checkGroupArray(t,"groupsToAdd"),o.push(h.Constants.ParameterCode.Add),o.push(m.TypeExt.Byte(t))),this.sendOperation(h.Constants.OperationCode.ChangeGroups,o)},e.prototype.checkGroupNumber=function(e){return!("number"!=typeof e||isNaN(e)||e===1/0||e===-1/0)},e.prototype.checkGroupArray=function(e,t){if(!Exitgames.Common.Util.isArray(e))throw new Error("changeGroups - groupsToRemove not an array: "+e);for(var o=0;o<e.length;++o){var n=e[o];if(!this.checkGroupNumber(n))throw new Error("changeGroups - "+t+" ("+e+") not an array of numbers: element "+o+" = "+n)}},e}(s);h.GamePeer=c}(m.LoadBalancing||(m.LoadBalancing={}))}(Photon||(Photon={})),function(e){var t,o;t=e.Lite||(e.Lite={}),(o=t.Constants||(t.Constants={})).LiteOpKey={ActorList:252,ActorNr:254,ActorProperties:249,Add:238,Broadcast:250,Cache:247,Code:244,Data:245,GameId:255,GameProperties:248,Group:240,Properties:251,ReceiverGroup:246,Remove:239,TargetActorNr:253,EmptyRoomLiveTime:236},o.LiteEventCode={Join:255,Leave:254,PropertiesChanged:253},o.LiteOpCode={ChangeGroups:248,GetProperties:251,Join:255,Leave:254,RaiseEvent:253,SetProperties:252}}(Photon||(Photon={})),function(e){var t,o,n,r,s;t=e.LoadBalancing||(e.LoadBalancing={}),o=t.Constants||(t.Constants={}),n=e.Lite.Constants.LiteOpKey,r=e.Lite.Constants.LiteOpCode,s=e.Lite.Constants.LiteEventCode,o.ErrorCode={Ok:0,OperationNotAllowedInCurrentState:-3,InvalidOperationCode:-2,InternalServerError:-1,InvalidAuthentication:32767,GameIdAlreadyExists:32766,GameFull:32765,GameClosed:32764,NoRandomMatchFound:32760,GameDoesNotExist:32758,MaxCcuReached:32757,InvalidRegion:32756},o.ActorProperties={PlayerName:255},o.GameProperties={MaxPlayers:255,IsVisible:254,IsOpen:253,PlayerCount:252,Removed:251,PropsListedInLobby:250,CleanupCacheOnLeave:249,MasterClientId:248},o.EventCode={GameList:230,GameListUpdate:229,QueueState:228,AppStats:226,AzureNodeInfo:210,Join:s.Join,Leave:s.Leave,PropertiesChanged:s.PropertiesChanged,Disconnect:252,LobbyStats:224},o.ParameterCode={Address:230,PeerCount:229,GameCount:228,MasterPeerCount:227,UserId:225,ApplicationId:224,Position:223,MatchMakingType:223,GameList:222,Secret:221,AppVersion:220,AzureNodeInfo:210,AzureLocalNodeId:209,AzureMasterNodeId:208,RoomName:n.GameId,Broadcast:n.Broadcast,ActorList:n.ActorList,ActorNr:n.ActorNr,PlayerProperties:n.ActorProperties,CustomEventContent:n.Data,Data:n.Data,Code:n.Code,GameProperties:n.GameProperties,Properties:n.Properties,TargetActorNr:n.TargetActorNr,ReceiverGroup:n.ReceiverGroup,Cache:n.Cache,CleanupCacheOnLeave:241,Group:n.Group,Remove:n.Remove,Add:n.Add,EmptyRoomTTL:n.EmptyRoomLiveTime,PlayerTTL:235,Plugins:204,ClientAuthenticationType:217,ClientAuthenticationParams:216,ClientAuthenticationData:214,JoinMode:215,MasterClientId:203,FindFriendsRequestList:1,FindFriendsResponseOnlineList:1,FindFriendsResponseRoomIdList:2,LobbyName:213,LobbyType:212,LobbyStats:211,Region:210,IsInactive:233,CheckUserOnJoin:232,ExpectedValues:231,UriPath:209,RpcCallParams:208,RpcCallRetCode:207,RpcCallRetMessage:206,RpcCallRetData:208,Forward:234,Nickname:202},o.OperationCode={Authenticate:230,JoinLobby:229,LeaveLobby:228,CreateGame:227,JoinGame:226,JoinRandomGame:225,Leave:r.Leave,RaiseEvent:r.RaiseEvent,SetProperties:r.SetProperties,GetProperties:r.GetProperties,ChangeGroups:r.ChangeGroups,FindFriends:222,LobbyStats:221,GetRegions:220,Rpc:219},o.MatchmakingMode={FillRoom:0,SerialMatching:1,RandomMatching:2},o.EventCaching={DoNotCache:0,MergeCache:1,ReplaceCache:2,RemoveCache:3,AddToRoomCache:4,AddToRoomCacheGlobal:5,RemoveFromRoomCache:6,RemoveFromRoomCacheForActorsLeft:7},o.ReceiverGroup={Others:0,All:1,MasterClient:2},o.CustomAuthenticationType={Custom:0,Steam:1,Facebook:2,None:255},o.LobbyType={Default:0,SqlLobby:2}}(Photon||(Photon={})),function(e){var t,o;t=e.Chat||(e.Chat={}),(o=t.Constants||(t.Constants={})).ParameterCode={Channels:0,Channel:1,Messages:2,Message:3,Senders:4,Sender:5,ChannelUserCount:6,UserId:225,MsgId:8,MsgIds:9,SubscribeResults:15,Status:10,Friends:11,SkipMessage:12,HistoryLength:14},o.OperationCode={Subscribe:0,Unsubscribe:1,Publish:2,SendPrivate:3,ChannelHistory:4,UpdateStatus:5,AddFriendds:6,RemoveFriends:7},o.EventCode={ChatMessages:0,Users:1,PrivateMessage:2,FriendsList:3,StatusUpdate:4,Subscribe:5,Unsubscribe:6},o.UserStatus={Offline:0,Invisible:1,Online:2,Away:3,Dnd:4,Lfg:5,Playing:6},o.UserStatusToName=function(e){return Exitgames.Common.Util.getEnumKeyByValue(o.UserStatus,e)}}(Photon||(Photon={})),function(t){!function(c){var s=function(){function e(e,t){this.sender=e,this.content=t}return e.prototype.getSender=function(){return this.sender},e.prototype.getContent=function(){return this.content},e}();c.Message=s;var n=function(){function e(e,t){this.name=e,this.isPrivat=t,this.messages=[]}return e.prototype.getName=function(){return this.name},e.prototype.isPrivate=function(){return this.isPrivat},e.prototype.getMessages=function(){return this.messages},e.prototype.clearMessages=function(){this.messages.splice(0)},e.prototype.addMessage=function(e){this.messages.push(e)},e.prototype.addMessages=function(e,t){var o=[];for(var n in e)if(parseInt(n)<t.length){var r=new s(e[n],t[n]);this.addMessage(r),o.push(r)}return o},e}();c.Channel=n;var e=function(r){function o(e,t,o){var n=r.call(this,e,t,o)||this;return n.publicChannels={},n.privateChannels={},n.subscribeRequests=[],n.unsubscribeRequests=[],n.autoJoinLobby=!1,n}return __extends(o,r),o.prototype.onStateChange=function(e){},o.prototype.onError=function(e,t){},o.prototype.onSubscribeResult=function(e){},o.prototype.onUnsubscribeResult=function(e){},o.prototype.onChatMessages=function(e,t){},o.prototype.onPrivateMessage=function(e,t){},o.prototype.onUserStatusUpdate=function(e,t,o,n){},o.prototype.connectToRegionFrontEnd=function(e){return this.connectToRegionMaster(e)},o.prototype.isConnectedToFrontEnd=function(){return this.state==o.ChatState.ConnectedToFrontEnd},o.prototype.subscribe=function(e,t){if(void 0===t&&(t=0),this.isConnectedToFrontEnd()){this.logger.debug("Subscribe channels:",e);var o=[];return o.push(c.Constants.ParameterCode.Channels,e),null!=t&&0!=t&&o.push(c.Constants.ParameterCode.HistoryLength,t),this.masterPeer.sendOperation(c.Constants.OperationCode.Subscribe,o),!0}return this.logger.error("subscribe request error:","Not connected to Front End"),!1},o.prototype.unsubscribe=function(e){if(this.isConnectedToFrontEnd()){this.logger.debug("Unsubscribe channels:",e);var t=[];return t.push(c.Constants.ParameterCode.Channels,e),this.masterPeer.sendOperation(c.Constants.OperationCode.Unsubscribe,t),!0}return this.logger.error("unsubscribe request error:","Not connected to Front End"),!1},o.prototype.publishMessage=function(e,t){if(this.isConnectedToFrontEnd()){var o=[];return o.push(c.Constants.ParameterCode.Channel,e),o.push(c.Constants.ParameterCode.Message,t),this.masterPeer.sendOperation(c.Constants.OperationCode.Publish,o),!0}return this.logger.error("publishMessage request error:","Not connected to Front End"),!1},o.prototype.sendPrivateMessage=function(e,t){if(this.isConnectedToFrontEnd()){var o=[];return o.push(c.Constants.ParameterCode.UserId,e),o.push(c.Constants.ParameterCode.Message,t),this.masterPeer.sendOperation(c.Constants.OperationCode.SendPrivate,o),!0}return this.logger.error("sendPrivateMessage request error:","Not connected to Front End"),!1},o.prototype.setUserStatus=function(e,t,o){if(void 0===t&&(t=null),void 0===o&&(o=!1),this.isConnectedToFrontEnd()){var n=[];return n.push(c.Constants.ParameterCode.Status,e),o?n.push(c.Constants.ParameterCode.SkipMessage,!0):n.push(c.Constants.ParameterCode.Message,t),this.masterPeer.sendOperation(c.Constants.OperationCode.UpdateStatus,n),!0}return this.logger.error("setUserStatus request error:","Not connected to Front End"),!1},o.prototype.addFriends=function(e){if(this.isConnectedToFrontEnd()){var t=[];return t.push(c.Constants.ParameterCode.Friends,e),this.masterPeer.sendOperation(c.Constants.OperationCode.AddFriendds,t),!0}return this.logger.error("addFriends request error:","Not connected to Front End"),!1},o.prototype.removeFriends=function(e){if(this.isConnectedToFrontEnd()){var t=[];return t.push(c.Constants.ParameterCode.Friends,e),this.masterPeer.sendOperation(c.Constants.OperationCode.RemoveFriends,t),!0}return this.logger.error("removeFriends request error:","Not connected to Front End"),!1},o.prototype.getPublicChannels=function(){return this.publicChannels},o.prototype.getPrivateChannels=function(){return this.privateChannels},o.prototype.getOrAddChannel=function(e,t,o){return null==e[t]&&(e[t]=new n(t,o)),e[t]},o.prototype.initMasterPeer=function(a){var i=this;r.prototype.initMasterPeer.call(this,a),a.addEventListener(c.Constants.EventCode.ChatMessages,function(e){var t=e.vals[c.Constants.ParameterCode.Senders],o=e.vals[c.Constants.ParameterCode.Messages],n=e.vals[c.Constants.ParameterCode.Channel],r=i.publicChannels[n];if(r){var s=r.addMessages(t,o);i.onChatMessages(n,s)}else a._logger.warn("ev ChatMessages: Got message from unsubscribed channel ",n)}),a.addEventListener(c.Constants.EventCode.PrivateMessage,function(e){var t=e.vals[c.Constants.ParameterCode.Sender],o=e.vals[c.Constants.ParameterCode.Message],n=e.vals[c.Constants.ParameterCode.UserId],r="";r=i.getUserId()==t?n:t;i.getOrAddChannel(i.privateChannels,r,!0);i.onPrivateMessage(r,new s(t,o))}),a.addEventListener(c.Constants.EventCode.StatusUpdate,function(e){var t=e.vals[c.Constants.ParameterCode.Sender],o=e.vals[c.Constants.ParameterCode.Status],n=e.vals[c.Constants.ParameterCode.Message],r=void 0!==n;i.onUserStatusUpdate(t,o,r,n)}),a.addEventListener(c.Constants.EventCode.Subscribe,function(e){a._logger.debug("ev Subscribe",e);var t={},o=e.vals[c.Constants.ParameterCode.Channels]||[],n=e.vals[c.Constants.ParameterCode.SubscribeResults]||[];for(var r in o){var s=o[r];t[s]=!1,r<n.length&&n[r]&&(i.getOrAddChannel(i.publicChannels,s,!1),t[s]=!0)}i.onSubscribeResult(t)}),a.addEventListener(c.Constants.EventCode.Unsubscribe,function(e){a._logger.debug("ev Unsubscribe",e);var t={},o=e.vals[c.Constants.ParameterCode.Channels]||[];for(var n in o){var r=o[n];delete i.publicChannels[r],t[r]=!0}i.onUnsubscribeResult(t)})},o.StateToName=function(e){var t=Exitgames.Common.Util.getEnumKeyByValue(o.ChatState,e);return void 0===t?Exitgames.Common.Util.getEnumKeyByValue(o.State,e):t},o.ChatPeerErrorCode={Ok:0,FrontEndError:1001,FrontEndConnectFailed:1002,FrontEndConnectClosed:1003,FrontEndTimeout:1004,FrontEndEncryptionEstablishError:1005,FrontEndAuthenticationFailed:1101,NameServerError:3001,NameServerConnectFailed:3002,NameServerConnectClosed:3003,NameServerTimeout:3004,NameServerEncryptionEstablishError:300,NameServerAuthenticationFailed:3101},o.ChatState={Error:-1,Uninitialized:0,ConnectingToNameServer:1,ConnectedToNameServer:2,ConnectingToFrontEnd:3,ConnectedToFrontEnd:4,Disconnected:10},o}(t.LoadBalancing.LoadBalancingClient);c.ChatClient=e}(t.Chat||(t.Chat={}))}(Photon||(Photon={}));var Connection=function(t,e,c){var n,p=this,o=-1;function r(e){p.pingInterval&&clearInterval(p.pingInterval),p.trace("Disconnected",t+" Reason:"+e,"disconnect"),p.onDisconnected&&p.onDisconnected(e),0==p.peer.isConnected()&&(-1<o&&(clearTimeout(o),o=-1),0<p.reconnectInterval&&0==p.peer.isConnected()&&(o=setTimeout(function(){0==p.peer.isConnected()&&p.connect()},1e3*p.reconnectInterval)))}function s(){1==p.peer.isConnected()&&1!=p.peer.isClosing()&&null!=p.enums.operations.sendPing&&null!=p.enums.operationParams.pingData&&(p.send(p.enums.operations.sendPing,[p.enums.operationParams.pingData,0]),0<p.pingInterval&&setTimeout(s,1e3*p.pingInterval))}function i(e,t){var o={};for(var n in e){var r=!1;for(var s in t)if(t[s]==n){o[s]=e[n],r=!0;break}if(Array.isArray(e[n]))for(var a=0;a<e[n].length;a++)"object"==typeof e[n][a]&&null!==e[n][a]&&(e[n][a]=i(e[n][a],t));0==r&&(o[n]=e[n])}return o}function d(e,t){for(var o in t)if(t[o]==e)return o;return e}c=1==c,p.enums=e,p.messageTimeout=60,p.reconnectInterval=3,p.pingInterval=3,p.peer,p.parseKey=function(e,t){for(var o in t)if(o==e||t[o]==e)return{hasKey:!0,prop:t[o]};return{hasKey:!1,prop:e}},p.prepareObjectToSend=function(e,t){var o=p.parseKey(e,p.enums.operations);if(1==o.hasKey){if(!t)return{op:o.prop,data:[]};var n=function(e,t){var o=[],n=[];for(var r in e){var s=!1;for(var a in t){if(a==r){o.push(t[a]),o.push(e[r]),s=!0;break}if(t[a]==r){o.push(t[a]),o.push(e[r]),s=!0;break}}0==s&&n.push(r)}return{data:o,novals:n}}(t,p.enums.operationParams);if(0==n.novals.length)return{op:o.prop,data:n.data};console.error(n.novals+" Values doesn't exists in scope.enums.operationParams")}else console.error(e+" Value doesn't exists in scope.enums.operations")},p.onEventInternalHandler=function(e,t,o){p.trace(e,t,"event"),n=new Date,t.eventKey=d(e,p.enums.events),t.vals=i(t.vals,p.enums.eventParams),o?o(t):p.onEvent&&p.onEvent(e,t)},p.onResponseInternalHandler=function(e,t,o){e!=p.enums.operations.sendPing&&(p.trace(e,t,"response"),n=new Date,t.code=e,t.codeKey=d(e,p.enums.operations),t.errCodeKey=d(t.errCode,p.enums.errorCodes),t.vals=i(t.vals,p.enums.operationParams),o?o(t):p.onResponse&&p.onResponse(e,t))},p.traceObject=function(e,t,o){if(e instanceof Object&&!Array.isArray(e))for(var n in e){var r=d(n,t);if(e[n]instanceof Object&&Array.isArray(e[n]),Array.isArray(e[n])){console.group("%c"+r+"%c ( "+n.toString()+" )",o+"#FDFBA8",o+"#94FFA3");for(var s=0;s<e[n].length;s++)console.group("( "+s.toString()+" )"),p.traceObject(e[n][s],t,o),console.groupEnd();console.groupEnd()}else console.log("%c"+r+"%c ( "+n.toString()+" ) = %c"+e[n],o+"#FDFBA8",o+"#94FFA3",o+"#ffffff")}else console.log("%c"+e,o+"#ffffff")},p.trace=function(e,t,o){if(0!=c){var n="color:";if("send"==o){if(console.groupCollapsed("%cSending : %c"+d(e,p.enums.operations)+" %c ( Code: "+e+" )",n+"#33FF4F",n+"#ffffff",n+"#94FFA3"),t)for(var r=0;r<t.length;r+=2){var s=d(t[r],p.enums.operationParams);console.log("%c"+s+"%c  ( "+t[r].toString()+" ) = %c"+t[r+1],n+"#33FF4F",n+"#94FFA3",n+"#ffffff","")}console.groupEnd()}if("response"==o){console.groupCollapsed("%cResponse : %c"+d(e,p.enums.operations)+" %c ( Code: "+e+" )",n+"#94DAFF",n+"#ffffff",n+"#94FFA3");var a=d(t.errCode,p.enums.errorCodes),i=t.errMsg&&0<t.errMsg.length?" = "+t.errMsg:"";console.log("%cError: %c"+a+"%c ( "+t.errCode.toString()+" )"+i,n+"#33FF4F",n+"#94FFA3",n+"#ffffff"),console.group("properties"),p.traceObject(t.vals,p.enums.operationParams,n),console.groupEnd(),console.groupEnd(),console.groupEnd()}"event"==o&&(console.groupCollapsed("%cEvent : %c"+d(e,p.enums.events)+" %c ( Code: "+e+" )",n+"#FFF92D",n+"#ffffff",n+"#94FFA3"),p.traceObject(t.vals,p.enums.eventParams,n),console.groupEnd(),console.groupEnd()),"connect"==o&&console.log("%cConnected : %c"+t,n+"#FFBA39",n+"#ffffff"),"disconnect"==o&&console.log("%cDisconnected : %c"+t,n+"#FF0000",n+"#ffffff")}},p.enums=null!=p.enums?p.enums:{},p.enums.operations=null!=p.enums.operations?p.enums.operations:{},p.enums.operationParams=null!=p.enums.operationParams?p.enums.operationParams:{},p.enums.events=null!=p.enums.events?p.enums.events:{},p.enums.eventParams=null!=p.enums.eventParams?p.enums.eventParams:{},p.enums.errorCodes=null!=p.enums.errorCodes?p.enums.errorCodes:{},p.peer=new Photon.PhotonPeer(t),p.peer.addPeerStatusListener(Photon.PhotonPeer.StatusCodes.connecting,function(){}),p.peer.addPeerStatusListener(Photon.PhotonPeer.StatusCodes.connect,function(){n=new Date,p.trace("Connected",t,"connect"),s(),p.onConnected&&p.onConnected()}),p.peer.addPeerStatusListener(Photon.PhotonPeer.StatusCodes.disconnect,function(){r(Photon.PhotonPeer.StatusCodes.disconnect)}),p.peer.addPeerStatusListener(Photon.PhotonPeer.StatusCodes.error,function(){r(Photon.PhotonPeer.StatusCodes.error)}),p.peer.addPeerStatusListener(Photon.PhotonPeer.StatusCodes.timeout,function(){r(Photon.PhotonPeer.StatusCodes.timeout)}),p.peer.addPeerStatusListener(Photon.PhotonPeer.StatusCodes.connectFailed,function(){r(Photon.PhotonPeer.StatusCodes.connectFailed)}),p.peer.addPeerStatusListener(Photon.PhotonPeer.StatusCodes.connectClosed,function(){r(Photon.PhotonPeer.StatusCodes.connectClosed)}),p.peer.onUnhandledResponse=p.onResponseInternalHandler,p.peer.onUnhandledEvent=p.onEventInternalHandler,p.connect(),window.addEventListener("focus",function(){!function(){if(n){var e=((new Date).getTime()-n.getTime())/1e3;e>p.messageTimeout&&p.onMessageTimeout&&p.onMessageTimeout()}}()})};Connection.prototype.connect=function(){console.log("CONNECTING"),this.peer._isClosing=!1,this.peer.connect()},Connection.prototype.disconnect=function(){this.peer.disconnect()},Connection.prototype.setAutoReconnect=function(e){this.reconnectInterval=e},Connection.prototype.sendPingInSeconds=function(e){void 0!==this.enums.operations.sendPing&&void 0!==this.enums.operationParams.pingData&&(this.pingInterval=e)},Connection.prototype.isDisconnected=function(){return 1!=this.peer.isConnected()},Connection.prototype.addEventListener=function(t,o){var n=this,e=n.parseKey(t,n.enums.events);n.peer.addEventListener(e.prop,function(e){n.onEventInternalHandler(t,e,o)})},Connection.prototype.addResponseListener=function(t,o){var n=this,e=n.parseKey(t,n.enums.operations);n.peer.addResponseListener(e.prop,function(e){n.onResponseInternalHandler(t,e,o)})},Connection.prototype.sendObject=function(e,t){if(1==this.peer.isConnected()){var o=this.prepareObjectToSend(e,t);this.send(o.op,o.data)}},Connection.prototype.send=function(e,t){1==this.peer.isConnected()&&1!=this.peer.isClosing()&&(this.trace(e,t,"send"),this.peer.sendOperation(e,t||[]))},Connection.prototype.sendDebugData=function(e){var t=this;void 0!==t.enums.operations.sendDebugData?void 0!==t.enums.operationParams.debugData?t.send(t.enums.operations.sendDebugData,[t.enums.operationParams.debugData,e]):console.error("'debugData' propery isn't defined in enums.operationParams"):console.error("'sendScreenshot' propery isn't defined in enums.operations")},Connection.prototype.sendScreenshot=function(e){void 0!==this.enums.operations.sendScreenshot?void 0!==this.enums.operationParams.debugData?console.warn("html2canvas was removed!"):console.error("'debugData' propery isn't defined in enums.operationParams"):console.error("'sendScreenshot' propery isn't defined in enums.operations")},"undefined"!=typeof module&&module.exports&&(module.exports=Connection);